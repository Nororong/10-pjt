{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container movie-list-container">

  <!-- íšŒì›íƒˆí‡´ ë©”ì‹œì§€ í‘œì‹œ -->
  {% if messages %}
    <div id="success-message" class="alert alert-success">
      {% for message in messages %}
        <p>{{ message }}</p>
      {% endfor %}
    </div>
  {% endif %}

  <div class="movie-main-img">
    <p></p>
  </div>

  <!-- ì˜í™” ëª©ë¡ -->
  <div>
    <p class="movie-main-title">ì˜¤ëŠ˜ì˜ ëœë¤ ì˜í™”! ğŸ˜</p>
    <div id="random-movies" class="movies-container">
      {% for movie in random_movies %}
      <div class="movie" data-genre-ids="{% for genre in movie.genres.all %}{{ genre.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
        <div class="poster-with-heart">
          <img class="heart-icon"
          src="{% static 'img/heart-none.png' %}"
          alt="icon"
          data-movie-id="{{ movie.id }}"
          {% if movie.id in liked_movie_ids %}
          data-is-liked="true"
          {% endif %}>
          <div class="poster-overlay"></div>
          <a href="{% url 'movies:movie_detail' movie.id %}">
            <img class="movie-poster" src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
          </a>
        </div>
        <h4 class="movie-title">{{ movie.title }}</h4>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- ì¥ë¥´ë³„ ì¸ê¸° ì˜í™” ì„¹ì…˜ -->
  <div class="record"></div>

  <div>
    <a class="movie-main-title-genre" href="{% url 'movies:movie_list' %}">
      <p class="movie-main-title">ì¥ë¥´ë³„ ì¸ê¸° ì˜í™” ğŸˆ &gt;</p>
    </a>
    <p class="movie-main-title-1">ì¥ë¥´ë³„ ì¸ê¸° ì˜í™”ë“¤ì„ ë§Œë‚˜ë³´ì„¸ìš”!</p>
    {% for genre_name, movies in genre_movies.items %}
    <div class="genre-section">
      <p class="movie-main-title">{{ genre_name }} <span>TOP</span> âœ¨</p>
      <div class="movies-container">
        {% for movie in movies %}
        <div class="movie" data-genre-ids="{% for genre in movie.genres.all %}{{ genre.id }}{% if not forloop.last %},{% endif %}{% endfor %}">
          <div class="poster-with-heart">
            <img class="heart-icon"
            src="{% static 'img/heart-none.png' %}"
            alt="icon"
            data-movie-id="{{ movie.id }}"
            {% if movie.id in liked_movie_ids %}
            data-is-liked="true"
            {% endif %}>
            <div class="poster-overlay"></div>
            <a href="{% url 'movies:movie_detail' movie.id %}">
              <img class="movie-poster" src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
            </a>
          </div>
          <h4 class="movie-title">{{ movie.title }}</h4>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endfor %}
  </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // íšŒì›íƒˆí‡´ ë©”ì‹œì§€ ìë™ ìˆ¨ê¸°ê¸°
    const successMessage = document.getElementById('success-message');
    if (successMessage) {
      setTimeout(function() {
        successMessage.style.display = 'none';  // 3ì´ˆ í›„ ë©”ì‹œì§€ ìˆ¨ê¸°ê¸°
      }, 3000);
    }

    // í•˜íŠ¸ ë²„íŠ¼ ì°œí•˜ê¸° ê¸°ëŠ¥
    const heartIcons = document.querySelectorAll('.heart-icon');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    heartIcons.forEach(icon => {
      if (icon.dataset.isLiked === "true") {
        icon.src = "{% static 'img/heart-fill.png' %}";
      }
    });

    const movieContainer = document.querySelector('.movie-list-container');
    movieContainer.addEventListener('click', function(event) {
      if (!event.target.classList.contains('heart-icon')) return;

      event.preventDefault();
      const movieId = event.target.dataset.movieId;

      axios({
        method: 'post',
        url: `/movies/${movieId}/likes/`,
        headers: { 'X-CSRFToken': csrftoken },
      })
        .then((response) => {
          const isLiked = response.data.is_liked;
          event.target.src = isLiked
            ? "{% static 'img/heart-fill.png' %}"
            : "{% static 'img/heart-none.png' %}";
          event.target.dataset.isLiked = isLiked.toString();
        })
        .catch((error) => {
          console.error(error);
        });
    });
  });
</script>

{% endblock content %}
