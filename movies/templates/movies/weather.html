{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="movie-list-container container">
  <p class="weather-movie-list"><strong class="weather-movie-list-name">{{ user.nickname }}</strong>ë‹˜ì˜ ì„ í˜¸ë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì˜¤ëŠ˜ ë‚ ì”¨ì— ì–´ìš¸ë¦¬ëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”! ğŸ¥°</p>
  {% if weather_condition %}
    <p><strong>{{ city }}</strong>ì˜ <strong>{{ korean_weather_description }}</strong> ë‚ ì”¨ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?</p>
    <p><strong>ì˜¤ëŠ˜ì˜ ì˜¨ë„</strong> : {{ temperature }}</p>

    {% if user.favorite_genres.all %}
      <p>ì„ í˜¸í•˜ì‹œëŠ” ì¥ë¥´:
        {% for genre in user.favorite_genres.all %}
          {{ genre.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </p>
    {% endif %}

    <!-- ì˜¨ë„ê¹Œì§€ ê³ ë ¤í•œ ì¶”ì²œ ë²„íŠ¼ -->
    <button id="considerTemperature">ì˜¨ë„ê¹Œì§€ ê³ ë ¤í•œ ì¶”ì²œì„ ì›í•´ìš”!</button>
    
    <!-- ì˜í™” ë¦¬ìŠ¤íŠ¸ -->
    {% if movies %}
      <div class="movies-container">
        {% for movie in movies %}
          <div class="movie" data-temperature="{{ movie.recommended_temperature|safe }}">
            <div class="poster-with-heart">
              <img class="heart-icon"
               src="{% static 'img/heart-none.png' %}"
               alt="icon"
               data-movie-id="{{ movie.id }}"
               {% if movie.id in liked_movie_ids %}
               data-is-liked="true"
               {% endif %}>
              <div class="poster-overlay"></div>
              <a href="{% url 'movies:movie_detail' movie.id %}">
                <img class="movie-poster" src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
              </a>
            </div>
            <p class="movie-title">{{ movie.title }}</p>
            <p class="weather-movie-genres">
              {% for genre in movie.genres.all %}
                {{ genre.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </p>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ë‚ ì”¨ì™€ ì„ í˜¸í•˜ì‹œëŠ” ì¥ë¥´ì— ë§ëŠ” ì˜í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  {% else %}
    <p>{{ error }}</p>
  {% endif %}
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ê¸°ì¡´ í•˜íŠ¸ ë²„íŠ¼ ì°œí•˜ê¸° ê¸°ëŠ¥
    const heartIcons = document.querySelectorAll('.heart-icon');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
    heartIcons.forEach(icon => {
      if (icon.dataset.isLiked === "true") {
        icon.src = "{% static 'img/heart-fill.png' %}";
      }
    });
  
    const movieContainer = document.querySelector('.movies-container');
    movieContainer.addEventListener('click', function (event) {
      if (!event.target.classList.contains('heart-icon')) return;
  
      const movieId = event.target.dataset.movieId;
  
      axios({
        method: 'post',
        url: `/movies/${movieId}/likes/`,
        headers: { 'X-CSRFToken': csrftoken },
      })
        .then((response) => {
          const isLiked = response.data.is_liked;
          event.target.src = isLiked
            ? "{% static 'img/heart-fill.png' %}"
            : "{% static 'img/heart-none.png' %}";
          event.target.dataset.isLiked = isLiked.toString();
        })
        .catch((error) => {
          console.log(error);
        });
    });
  
    // ì˜¨ë„ì— ë”°ë¥¸ ì˜í™” í•„í„°ë§ ê¸°ëŠ¥
    const temperatureButton = document.getElementById('considerTemperature');
    if (temperatureButton) {
      temperatureButton.addEventListener('click', function () {
        const currentTemperature = "{{ current_temperature_category }}";
        const movies = document.querySelectorAll('.movie');
        let visibleMoviesCount = 0;
  
        movies.forEach(movie => {
          const movieTemperatures = JSON.parse(movie.dataset.temperature);

          // ì˜í™”ì˜ ì¶”ì²œ ì˜¨ë„ê°€ í˜„ì¬ ì˜¨ë„ ì¹´í…Œê³ ë¦¬ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
          if (movieTemperatures.includes(currentTemperature)) {
            movie.style.display = 'block';
            visibleMoviesCount++;
          } else {
            movie.style.display = 'none';
          }
        });
        
        // ì˜¨ë„ì— ë§ëŠ” ì˜í™”ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
        let noMatchMessage = document.getElementById('noMatchMessage');
        if (visibleMoviesCount === 0) {
          if (!noMatchMessage) {
            noMatchMessage = document.createElement('p');
            noMatchMessage.id = 'noMatchMessage';
            noMatchMessage.textContent = 'í˜„ì¬ ì˜¨ë„ì— ë§ëŠ” ì˜í™”ê°€ ì—†ìŠµë‹ˆë‹¤.';
            document.querySelector('.movies-container').appendChild(noMatchMessage);
          }
          noMatchMessage.style.display = 'block';
        } else if (noMatchMessage) {
          noMatchMessage.style.display = 'none';
        }

        // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìˆ˜ì •
        this.textContent = 'ëª¨ë“  ì˜í™” ë³´ê¸°';
        this.onclick = function () {
          movies.forEach(movie => {
            movie.style.display = 'block';
          });
          if (noMatchMessage) noMatchMessage.style.display = 'none';
          this.textContent = 'ì˜¨ë„ê¹Œì§€ ê³ ë ¤í•œ ì¶”ì²œì„ ì›í•´ìš”!';
          this.onclick = null;
        };
      });
    }
  });

  // ê¸°ì¡´ ì½”ë“œ
  {% comment %}
  document.getElementById('considerTemperature').addEventListener('click', function() {
    var currentTemperature = "{{ current_temperature_category }}";  // í˜„ì¬ ì˜¨ë„ ì¹´í…Œê³ ë¦¬
    var movies = document.querySelectorAll('.movie');
    var visibleMoviesCount = 0;
    
    movies.forEach(function(movie) {
      var movieTemperatures = JSON.parse(movie.dataset.temperature);
      
      // ì˜í™”ì˜ ì¶”ì²œ ì˜¨ë„ê°€ í˜„ì¬ ì˜¨ë„ ì¹´í…Œê³ ë¦¬ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
      if (movieTemperatures.includes(currentTemperature)) {
        movie.style.display = 'block';
        visibleMoviesCount++;
      } else {
        movie.style.display = 'none';
      }
    });

    // ì˜¨ë„ì— ë§ëŠ” ì˜í™”ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ í‘œì‹œ
    var noMatchMessage = document.getElementById('noMatchMessage');
    if (visibleMoviesCount === 0) {
      if (!noMatchMessage) {
        noMatchMessage = document.createElement('p');
        noMatchMessage.id = 'noMatchMessage';
        noMatchMessage.textContent = 'í˜„ì¬ ì˜¨ë„ì— ë§ëŠ” ì˜í™”ê°€ ì—†ìŠµë‹ˆë‹¤.';
        document.querySelector('.movies-container').appendChild(noMatchMessage);
      }
      noMatchMessage.style.display = 'block';
    } else if (noMatchMessage) {
      noMatchMessage.style.display = 'none';
    }

    // ë²„íŠ¼ í…ìŠ¤íŠ¸ ë³€ê²½ ë° ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ìˆ˜ì •
    this.textContent = 'ëª¨ë“  ì˜í™” ë³´ê¸°';
    this.onclick = function() {
      movies.forEach(function(movie) {
        movie.style.display = 'block';
      });
      if (noMatchMessage) noMatchMessage.style.display = 'none';
      this.textContent = 'ì˜¨ë„ê¹Œì§€ ê³ ë ¤í•œ ì¶”ì²œì„ ì›í•´ìš”!';
      this.onclick = null;
    };
  });
  {% endcomment %}

</script>
{% endblock %}