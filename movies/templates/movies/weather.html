{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="movie-list-container container">
  <p class="weather-movie-list"><strong class="weather-movie-list-name">{{ user.nickname }}</strong>ë‹˜ì˜ ì„ í˜¸ë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì˜¤ëŠ˜ ë‚ ì”¨ì— ì–´ìš¸ë¦¬ëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”! ğŸ¥°</p>
  {% if weather_condition %}
    <p><strong>{{ city }}</strong>ì˜ <strong>{{ korean_weather_description }}</strong> ë‚ ì”¨ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?</p>
    <p><strong>ì˜¤ëŠ˜ì˜ ì˜¨ë„</strong> : {{ temperature }}Â°C</p>

    {% if user.favorite_genres.all %}
      <p><strong>ì„ í˜¸ ì¥ë¥´</strong> :
        {% for genre in user.favorite_genres.all %}
          {{ genre.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </p>
    {% endif %}

    <button id="toggleRecommendedButton" class="custom-weather-button">ì¶”ì²œ ì˜í™” ë³´ê¸°</button>

    {% if movies %}
      <div class="movies-container">
        {% for movie in movies %}
          <div class="movie" data-temperature="{{ movie.recommended_temperature|safe }}">
            <div class="poster-with-heart">
              <img class="heart-icon"
               src="{% static 'img/heart-none.png' %}"
               alt="icon"
               data-movie-id="{{ movie.id }}"
               {% if movie.id in liked_movie_ids %}
               data-is-liked="true"
               {% endif %}>
              <div class="poster-overlay"></div>
              <a href="{% url 'movies:movie_detail' movie.id %}">
                <img class="movie-poster" src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
              </a>
            </div>
            <p class="movie-title">{{ movie.title }}</p>
            <p class="weather-movie-genres">
              {% for genre in movie.genres.all %}
                {{ genre.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </p>
            {% if movie.is_recommended_for_current_temp %}
              <p class="recommended-badge" style="color:#f439b5; display: none;"><strong>í˜„ì¬ ì˜¨ë„ì— ì¶”ì²œ!</strong></p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ë‚ ì”¨ì™€ ì„ í˜¸í•˜ì‹œëŠ” ì¥ë¥´ì— ë§ëŠ” ì˜í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  {% else %}
    <p>{{ error }}</p>
  {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ê¸°ì¡´ í•˜íŠ¸ ë²„íŠ¼ ì°œí•˜ê¸° ê¸°ëŠ¥
  const heartIcons = document.querySelectorAll('.heart-icon');
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  heartIcons.forEach(icon => {
    if (icon.dataset.isLiked === "true") {
      icon.src = "{% static 'img/heart-fill.png' %}";
    }
  });

  const movieContainer = document.querySelector('.movies-container');
  movieContainer.addEventListener('click', function (event) {
    if (!event.target.classList.contains('heart-icon')) return;

    const movieId = event.target.dataset.movieId;

    axios({
      method: 'post',
      url: `/movies/${movieId}/likes/`,
      headers: { 'X-CSRFToken': csrftoken },
    })
      .then((response) => {
        const isLiked = response.data.is_liked;
        event.target.src = isLiked
          ? "{% static 'img/heart-fill.png' %}"
          : "{% static 'img/heart-none.png' %}";
        event.target.dataset.isLiked = isLiked.toString();
      })
      .catch((error) => {
        console.log(error);
      });
  });

  // ì¶”ì²œ ì˜í™” í† ê¸€ ê¸°ëŠ¥
  const toggleRecommendedButton = document.getElementById('toggleRecommendedButton');
  const movies = document.querySelectorAll('.movie');
  let isRecommendedVisible = false;

  toggleRecommendedButton.addEventListener('click', function() {
    isRecommendedVisible = !isRecommendedVisible;
    movies.forEach(movie => {
      const badge = movie.querySelector('.recommended-badge');
      if (badge) {
        badge.style.display = isRecommendedVisible ? 'block' : 'none';
      }
      movie.style.display = isRecommendedVisible && !badge ? 'none' : 'block';
    });
    this.textContent = isRecommendedVisible ? 'ëª¨ë“  ì˜í™” ë³´ê¸°' : 'ì¶”ì²œ ì˜í™” ë³´ê¸°';
  });
});
</script>
{% endblock %}