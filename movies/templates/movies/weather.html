{% extends "base.html" %}
{% load static %}

{% block content %}

<div class="container weather-search-form">
  <p class="weather-movie-list"><strong class="weather-movie-list-name">{{ user.nickname }}</strong>ë‹˜ì˜ ì„ í˜¸ë„ë¥¼ ê¸°ë°˜ìœ¼ë¡œ, ì˜¤ëŠ˜ ë‚ ì”¨ì— ì–´ìš¸ë¦¬ëŠ” ì˜í™”ë¥¼ ì¶”ì²œí•´ ë“œë¦´ê²Œìš”! ğŸ¥°</p>
  <form action="{% url "movies:movie_list" %}" method="GET">
    <input type="text" name="searched_movies" value="{{ searched_movies }}" placeholder="ì›í•˜ëŠ” ì˜í™”ë¥¼ ê²€ìƒ‰í•´ìš”!">
    <button>ê²€ìƒ‰</button>
  </form>
</div>

{% comment %} <div class="container weather-search-form">
  <form action="{% url "movies:movie_list" %}" method="GET">
    <input type="text" name="searched_movies" value="{{ searched_movies }}" placeholder="ì›í•˜ëŠ” ì˜í™”ë¥¼ ê²€ìƒ‰í•´ìš”!">
    <button>ê²€ìƒ‰</button>
  </form>
</div> {% endcomment %}

<div class="movie-list-container container">
  {% if weather_condition %}
  <p><strong>{{ city }}</strong>ì˜ <strong>{{ korean_weather_description }}</strong> ë‚ ì”¨ì™€ ì–´ìš¸ë¦¬ëŠ” ì˜í™”ëŠ”?</p>
    <p><strong>ì˜¤ëŠ˜ì˜ ì˜¨ë„</strong> : {{ temperature }}Â°C</p>

    {% if user.favorite_genres.all %}
      <p><strong>ì„ í˜¸ ì¥ë¥´</strong> :
        {% for genre in user.favorite_genres.all %}
          {{ genre.name }}{% if not forloop.last %}, {% endif %}
        {% endfor %}
      </p>
    {% endif %}

    <button id="toggleRecommendedButton" class="custom-weather-button">ì¶”ì²œ ì˜í™” ë³´ê¸°</button>

    {% if movies %}
      <div class="movies-container">
        {% for movie in movies %}
          <div class="movie" data-temperature="{{ movie.recommended_temperature|safe }}">
            <div class="poster-with-heart">
              <img class="heart-icon"
                   src="{% static 'img/heart-none.png' %}"
                   alt="icon"
                   data-movie-id="{{ movie.id }}"
                   {% if movie.id in liked_movie_ids %}
                   data-is-liked="true"
                   {% endif %}>
              <div class="poster-overlay"></div>
              <a href="{% url 'movies:movie_detail' movie.id %}">
                <img class="movie-poster" src="https://image.tmdb.org/t/p/w300{{ movie.poster_path }}" alt="{{ movie.title }}">
              </a>
            </div>
            <p class="movie-title">{{ movie.title }}</p>
            <p class="weather-movie-genres">
              {% for genre in movie.genres.all %}
                {{ genre.name }}{% if not forloop.last %}, {% endif %}
              {% endfor %}
            </p>
            {% if movie.is_recommended_for_current_temp %}
              <p class="recommended-badge" style="color:#f439b5; display: none;"><strong>í˜„ì¬ ì˜¨ë„ì— ì¶”ì²œ!</strong></p>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p>ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ì¬ ë‚ ì”¨ì™€ ì„ í˜¸í•˜ì‹œëŠ” ì¥ë¥´ì— ë§ëŠ” ì˜í™”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
    {% endif %}
  {% else %}
    <p>{{ error }}</p>
  {% endif %}
</div>
<button id="scrollToTopButton" title="Go to top">â–²</button>

<style>
  #scrollToTopButton {
    display: none; /* ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€ */
    position: fixed;
    bottom: 20px;
    right: 30px;
    z-index: 99;
    font-size: 18px;
    border: none;
    outline: none;
    background-color: #555;
    color: white;
    cursor: pointer;
    padding: 15px;
    border-radius: 4px;
  }

  #scrollToTopButton:hover {
    background-color: #333;
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const heartIcons = document.querySelectorAll('.heart-icon');
    const movieContainer = document.querySelector('.movies-container');
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
    // localStorageì—ì„œ ì¢‹ì•„ìš” ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
    function getLikedMovies() {
      return JSON.parse(localStorage.getItem('likedMovies')) || {};
    }
  
    // localStorageì— ì¢‹ì•„ìš” ìƒíƒœ ì €ì¥í•˜ê¸°
    function saveLikedMovies(likedMovies) {
      localStorage.setItem('likedMovies', JSON.stringify(likedMovies));
    }
  
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    function initializeHeartIcons() {
      const likedMovies = getLikedMovies();
      heartIcons.forEach(icon => {
        const movieId = icon.dataset.movieId;
        if (likedMovies[movieId]) {
          icon.src = "{% static 'img/heart-fill.png' %}";
          icon.dataset.isLiked = "true";
        } else {
          icon.src = "{% static 'img/heart-none.png' %}";
          icon.dataset.isLiked = "false";
        }
      });
    }
  
    // ì´ˆê¸°í™” ì‹¤í–‰
    initializeHeartIcons();
  
    // í´ë¦­ ì´ë²¤íŠ¸ ì²˜ë¦¬ -> ì¢‹ì•„ìš”, ì¢‹ì•„ìš” í•´ì œ
    movieContainer.addEventListener('click', function (event) {
      if (!event.target.classList.contains('heart-icon')) return;
  
      event.preventDefault();
  
      // ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œ í•˜íŠ¸ í´ë¦­ ì‹œ, ì•ŒëŸ¿ + ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
      if (!isUserLoggedIn) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ í˜ì´ì§€ì…ë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.')
        window.location.href = "{% url 'accounts:login' %}"
        return
      }
  
      const movieId = event.target.dataset.movieId;
  
      // í†µí†µ íŠ€ëŠ” ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
      event.target.classList.add('bounce');
  
      // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚œ í›„ í´ë˜ìŠ¤ ì œê±°
      event.target.addEventListener('animationend', function() {
        event.target.classList.remove('bounce');
      });
  
      axios({
        method: 'post',
        url: `/movies/${movieId}/likes/`,
        headers: { 'X-CSRFToken': csrftoken },
      })
        .then((response) => {
          const isLiked = response.data.is_liked;
          event.target.src = isLiked
            ? "{% static 'img/heart-fill.png' %}" // ì¢‹ì•„ìš” ìƒíƒœ
            : "{% static 'img/heart-none.png' %}"; // ì¢‹ì•„ìš” í•´ì œ ìƒíƒœ
          event.target.dataset.isLiked = isLiked.toString(); // `data-is-liked` ë™ê¸°í™”
  
          // localStorage ì—…ë°ì´íŠ¸
          const likedMovies = getLikedMovies();
          if (isLiked) {
            likedMovies[movieId] = true;
          } else {
            delete likedMovies[movieId];
          }
          saveLikedMovies(likedMovies);
        })
        .catch((error) => {
          console.log(error);
        });
    });
    const toggleRecommendedButton = document.getElementById('toggleRecommendedButton');
    const movies = document.querySelectorAll('.movie');
    let isRecommendedVisible = false;
  
    toggleRecommendedButton.addEventListener('click', function() {
      isRecommendedVisible = !isRecommendedVisible;
      movies.forEach(movie => {
        const badge = movie.querySelector('.recommended-badge');
        if (badge) {
          badge.style.display = isRecommendedVisible ? 'block' : 'none';
        }
        movie.style.display = isRecommendedVisible && !badge ? 'none' : 'block';
      });
      this.textContent = isRecommendedVisible ? 'ëª¨ë“  ì˜í™” ë³´ê¸°' : 'ì¶”ì²œ ì˜í™” ë³´ê¸°';
    });
    const scrollToTopButton = document.getElementById('scrollToTopButton');

    window.onscroll = function() { scrollFunction() };
  
    function scrollFunction() {
      if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
        scrollToTopButton.style.display = "block";
      } else {
        scrollToTopButton.style.display = "none";
      }
    }
  
    scrollToTopButton.addEventListener('click', function() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  });
</script>
{% endblock %}